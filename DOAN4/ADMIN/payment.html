<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê·∫∑t V√© Xem Phim - Thanh to√°n Crypto</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 500px;
            margin: 50px auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .ticket-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .ticket-info h2 {
            color: #333;
            font-size: 20px;
            margin-bottom: 15px;
        }

        .ticket-info p {
            color: #666;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .price {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
            margin-top: 15px;
        }

        .wallet-status {
            background: #e7f3ff;
            border: 2px solid #2196F3;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .wallet-status.connected {
            background: #e8f5e9;
            border-color: #4CAF50;
        }

        .wallet-status p {
            margin: 0;
            color: #333;
            font-size: 14px;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(76, 175, 80, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        .alert-error {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
        }

        .alert-success {
            background: #e8f5e9;
            border: 1px solid #4CAF50;
            color: #2e7d32;
        }

        .alert p {
            margin: 0;
            font-size: 14px;
        }

        .tx-hash {
            word-break: break-all;
            font-family: monospace;
            font-size: 12px;
            margin-top: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.05);
            border-radius: 5px;
        }

        .tx-link {
            display: inline-block;
            margin-top: 10px;
            color: #2196F3;
            text-decoration: none;
            font-size: 14px;
        }

        .tx-link:hover {
            text-decoration: underline;
        }

        .network-info {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            text-align: center;
            font-size: 12px;
            color: #999;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        .debug-info {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin-top: 20px;
            font-size: 12px;
            font-family: monospace;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé¨ ƒê·∫∑t V√© Xem Phim</h1>
            <p>Thanh to√°n b·∫±ng CoinEx Smart Chain</p>
        </div>

        <div class="content">
            <!-- Th√¥ng tin v√© -->
            <div class="ticket-info">
                <h2 id="movieTitle">Avatar: The Way of Water</h2>
                <p>‚è∞ Su·∫•t chi·∫øu: <strong id="showtime">19:00 - 11/11/2025</strong></p>
                <p>üí∫ Gh·∫ø: <strong id="seats">A5, A6</strong></p>
                <p>üé´ Lo·∫°i v√©: <strong id="ticketType">Standard</strong></p>
                <div class="price"><span id="price">0.01</span> CET</div>
            </div>

            <!-- Tr·∫°ng th√°i v√≠ -->
            <div id="walletStatus" class="wallet-status">
                <p>‚úÖ ƒê√£ k·∫øt n·ªëi: <strong id="connectedAddress"></strong></p>
            </div>

            <!-- N√∫t k·∫øt n·ªëi/thanh to√°n -->
            <button id="connectBtn" class="btn btn-primary">
                üîó K·∫øt n·ªëi v√≠ MetaMask
            </button>

            <button id="payBtn" class="btn btn-success" style="display: none;">
                üí≥ Thanh to√°n ngay
            </button>

            <!-- Th√¥ng b√°o -->
            <div id="errorAlert" class="alert alert-error"></div>
            <div id="successAlert" class="alert alert-success"></div>

            <!-- Debug info -->
            <div id="debugInfo" class="debug-info">
                <strong>Debug Info:</strong><br>
                <span id="debugText">ƒêang ki·ªÉm tra MetaMask...</span>
            </div>

            <!-- Th√¥ng tin m·∫°ng -->
            <div class="network-info">
                <p>M·∫°ng: CoinEx Smart Chain Testnet</p>
                <p>ƒê·ªãa ch·ªâ nh·∫≠n: <strong>0x9cb7...77b63</strong></p>
            </div>
        </div>
    </div>

    <script>
        // C·∫•u h√¨nh
        const CONFIG = {
            chainId: '0x35', // 53 in decimal
            chainName: 'CoinEx Smart Chain Testnet',
            nativeCurrency: {
                name: 'CET',
                symbol: 'CET',
                decimals: 18
            },
            rpcUrls: ['https://testnet-rpc.coinex.net'],
            blockExplorerUrls: ['https://testnet.coinex.net'],
            merchantAddress: '0x9cb7a7c9a160cd7f16121953cfe0a1d598c77b63'
        };

        // State
        let userAccount = null;
        let isConnected = false;

        // DOM Elements
        const connectBtn = document.getElementById('connectBtn');
        const payBtn = document.getElementById('payBtn');
        const walletStatus = document.getElementById('walletStatus');
        const connectedAddress = document.getElementById('connectedAddress');
        const errorAlert = document.getElementById('errorAlert');
        const successAlert = document.getElementById('successAlert');
        const debugText = document.getElementById('debugText');

        // Update debug info
        function updateDebug(message) {
            debugText.textContent = message;
            console.log('[DEBUG]', message);
        }

        // H√†m hi·ªÉn th·ªã l·ªói
        function showError(message) {
            errorAlert.innerHTML = `<p>‚ùå ${message}</p>`;
            errorAlert.style.display = 'block';
            successAlert.style.display = 'none';
            setTimeout(() => {
                errorAlert.style.display = 'none';
            }, 5000);
        }

        // H√†m hi·ªÉn th·ªã th√†nh c√¥ng
        function showSuccess(message, txHash = null) {
            let html = `<p>‚úÖ ${message}</p>`;
            if (txHash) {
                html += `<div class="tx-hash">TX Hash: ${txHash}</div>`;
                html += `<a href="${CONFIG.blockExplorerUrls[0]}/tx/${txHash}" target="_blank" class="tx-link">Xem tr√™n Block Explorer ‚Üí</a>`;
            }
            successAlert.innerHTML = html;
            successAlert.style.display = 'block';
            errorAlert.style.display = 'none';
        }

        // Ki·ªÉm tra MetaMask ƒë√£ load ch∆∞a
        async function checkMetaMask() {
            updateDebug('ƒêang t√¨m ki·∫øm MetaMask...');
            
            // ƒê·ª£i t·ªëi ƒëa 3 gi√¢y ƒë·ªÉ MetaMask load
            for (let i = 0; i < 10; i++) {
                if (typeof window.ethereum !== 'undefined') {
                    updateDebug('‚úÖ ƒê√£ t√¨m th·∫•y MetaMask! Provider: ' + (window.ethereum.isMetaMask ? 'MetaMask' : 'Unknown'));
                    return true;
                }
                await new Promise(resolve => setTimeout(resolve, 300));
                updateDebug(`ƒê·ª£i MetaMask load... (${i + 1}/10)`);
            }
            
            updateDebug('‚ùå Kh√¥ng t√¨m th·∫•y MetaMask sau 3 gi√¢y');
            return false;
        }

        // K·∫øt n·ªëi v√≠
        async function connectWallet() {
            try {
                updateDebug('B·∫Øt ƒë·∫ßu k·∫øt n·ªëi v√≠...');
                
                const hasMetaMask = await checkMetaMask();
                
                if (!hasMetaMask) {
                    showError('Kh√¥ng t√¨m th·∫•y MetaMask! Vui l√≤ng c√†i ƒë·∫∑t MetaMask extension v√† refresh l·∫°i trang.');
                    updateDebug('‚ùå Vui l√≤ng c√†i ƒë·∫∑t MetaMask t·ª´: https://metamask.io/download/');
                    return;
                }

                updateDebug('ƒêang y√™u c·∫ßu quy·ªÅn truy c·∫≠p t√†i kho·∫£n...');

                // Request accounts
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });

                userAccount = accounts[0];
                updateDebug(`‚úÖ ƒê√£ k·∫øt n·ªëi t√†i kho·∫£n: ${userAccount}`);

                // Chuy·ªÉn sang CoinEx Smart Chain Testnet
                updateDebug('ƒêang chuy·ªÉn sang CoinEx Smart Chain Testnet...');
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: CONFIG.chainId }],
                    });
                    updateDebug('‚úÖ ƒê√£ chuy·ªÉn sang CoinEx Smart Chain Testnet');
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        updateDebug('M·∫°ng ch∆∞a t·ªìn t·∫°i, ƒëang th√™m v√†o MetaMask...');
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [CONFIG],
                        });
                        updateDebug('‚úÖ ƒê√£ th√™m m·∫°ng th√†nh c√¥ng');
                    } else {
                        throw switchError;
                    }
                }

                // C·∫≠p nh·∫≠t UI
                isConnected = true;
                connectedAddress.textContent = `${userAccount.slice(0, 6)}...${userAccount.slice(-4)}`;
                walletStatus.style.display = 'block';
                walletStatus.classList.add('connected');
                connectBtn.style.display = 'none';
                payBtn.style.display = 'flex';
                updateDebug('‚úÖ K·∫øt n·ªëi ho√†n t·∫•t! S·∫µn s√†ng thanh to√°n.');

            } catch (error) {
                updateDebug('‚ùå L·ªói: ' + error.message);
                showError('L·ªói k·∫øt n·ªëi v√≠: ' + error.message);
            }
        }

        // Thanh to√°n
        async function processPayment() {
            try {
                if (!isConnected) {
                    showError('Vui l√≤ng k·∫øt n·ªëi v√≠ tr∆∞·ªõc!');
                    return;
                }

                updateDebug('ƒêang chu·∫©n b·ªã giao d·ªãch...');

                // Disable button
                payBtn.disabled = true;
                payBtn.innerHTML = '<div class="spinner"></div> ƒêang x·ª≠ l√Ω...';

                // L·∫•y gi√° v√©
                const price = parseFloat(document.getElementById('price').textContent);
                const amountInWei = '0x' + (price * 1e18).toString(16);

                updateDebug(`S·ªë ti·ªÅn: ${price} CET (${amountInWei} Wei)`);

                // T·∫°o transaction
                const transactionParameters = {
                    from: userAccount,
                    to: CONFIG.merchantAddress,
                    value: amountInWei
                };

                updateDebug('ƒêang g·ª≠i y√™u c·∫ßu thanh to√°n ƒë·∫øn MetaMask...');

                // G·ª≠i transaction
                const txHash = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [transactionParameters],
                });

                updateDebug(`‚úÖ Giao d·ªãch ƒë√£ ƒë∆∞·ª£c g·ª≠i! TX Hash: ${txHash}`);

                // Hi·ªÉn th·ªã th√†nh c√¥ng
                showSuccess('Thanh to√°n th√†nh c√¥ng!', txHash);

                // G·ª≠i th√¥ng tin ƒë·∫øn backend ASP.NET Core
                await confirmTicketWithBackend(txHash);

            } catch (error) {
                updateDebug('‚ùå L·ªói thanh to√°n: ' + error.message);
                showError('L·ªói thanh to√°n: ' + error.message);
            } finally {
                payBtn.disabled = false;
                payBtn.innerHTML = 'üí≥ Thanh to√°n ngay';
            }
        }

        // G·ª≠i th√¥ng tin ƒë·∫øn backend
        async function confirmTicketWithBackend(txHash) {
            try {
                updateDebug('ƒêang g·ª≠i th√¥ng tin ƒë·∫øn backend...');

                const ticketData = {
                    txHash: txHash,
                    userAddress: userAccount,
                    movieTitle: document.getElementById('movieTitle').textContent,
                    showtime: document.getElementById('showtime').textContent,
                    seats: document.getElementById('seats').textContent,
                    ticketType: document.getElementById('ticketType').textContent,
                    amount: parseFloat(document.getElementById('price').textContent)
                };

                // TODO: Thay ƒë·ªïi URL n√†y th√†nh URL backend th·∫≠t c·ªßa b·∫°n
                const apiUrl = 'https://localhost:5001/api/tickets/confirm';
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(ticketData)
                });

                if (response.ok) {
                    const result = await response.json();
                    updateDebug('‚úÖ Backend x√°c nh·∫≠n th√†nh c√¥ng: ' + JSON.stringify(result));
                    console.log('Backend response:', result);
                } else {
                    updateDebug('‚ö†Ô∏è Backend tr·∫£ v·ªÅ l·ªói: ' + response.status);
                    console.error('Backend error:', await response.text());
                }
            } catch (error) {
                // Kh√¥ng hi·ªÉn th·ªã l·ªói cho user v√¨ transaction ƒë√£ th√†nh c√¥ng
                updateDebug('‚ö†Ô∏è Kh√¥ng th·ªÉ k·∫øt n·ªëi backend: ' + error.message);
                console.error('Error calling backend:', error);
            }
        }

        // Event listeners
        connectBtn.addEventListener('click', connectWallet);
        payBtn.addEventListener('click', processPayment);

        // Ki·ªÉm tra MetaMask khi trang load
        window.addEventListener('load', async () => {
            updateDebug('Trang ƒë√£ load, ƒëang ki·ªÉm tra MetaMask...');
            
            const hasMetaMask = await checkMetaMask();
            
            if (hasMetaMask) {
                // T·ª± ƒë·ªông k·∫øt n·ªëi n·∫øu ƒë√£ k·∫øt n·ªëi tr∆∞·ªõc ƒë√≥
                try {
                    const accounts = await window.ethereum.request({ 
                        method: 'eth_accounts' 
                    });
                    if (accounts.length > 0) {
                        userAccount = accounts[0];
                        isConnected = true;
                        connectedAddress.textContent = `${userAccount.slice(0, 6)}...${userAccount.slice(-4)}`;
                        walletStatus.style.display = 'block';
                        walletStatus.classList.add('connected');
                        connectBtn.style.display = 'none';
                        payBtn.style.display = 'flex';
                        updateDebug('‚úÖ T·ª± ƒë·ªông k·∫øt n·ªëi l·∫°i th√†nh c√¥ng');
                    } else {
                        updateDebug('Ch∆∞a k·∫øt n·ªëi, vui l√≤ng nh·∫•n n√∫t "K·∫øt n·ªëi v√≠"');
                    }
                } catch (error) {
                    updateDebug('Ch∆∞a k·∫øt n·ªëi: ' + error.message);
                }
            }
        });

        // L·∫Øng nghe thay ƒë·ªïi account
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', function (accounts) {
                if (accounts.length === 0) {
                    isConnected = false;
                    userAccount = null;
                    walletStatus.style.display = 'none';
                    connectBtn.style.display = 'flex';
                    payBtn.style.display = 'none';
                    updateDebug('ƒê√£ ng·∫Øt k·∫øt n·ªëi v√≠');
                } else {
                    userAccount = accounts[0];
                    connectedAddress.textContent = `${userAccount.slice(0, 6)}...${userAccount.slice(-4)}`;
                    updateDebug('ƒê√£ chuy·ªÉn t√†i kho·∫£n: ' + userAccount);
                }
            });

            window.ethereum.on('chainChanged', function (chainId) {
                updateDebug('M·∫°ng ƒë√£ thay ƒë·ªïi, ƒëang reload...');
                window.location.reload();
            });
        }
    </script>
</body>
</html>