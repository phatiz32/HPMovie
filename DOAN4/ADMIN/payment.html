<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh to√°n Order - Crypto</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 500px;
            margin: 30px auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }

        .header h1 {
            font-size: 22px;
            margin-bottom: 5px;
        }

        .content {
            padding: 25px;
        }

        .order-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .order-info h2 {
            color: #333;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .info-label {
            color: #666;
        }

        .info-value {
            color: #333;
            font-weight: 600;
        }

        .price-section {
            background: linear-gradient(135deg, #667eea15, #764ba215);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .total-price {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            margin-top: 10px;
        }

        .wallet-status {
            background: #e7f3ff;
            border: 2px solid #2196F3;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .wallet-status.connected {
            background: #e8f5e9;
            border-color: #4CAF50;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
            font-size: 14px;
        }

        .alert-error {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
        }

        .alert-success {
            background: #e8f5e9;
            border: 1px solid #4CAF50;
            color: #2e7d32;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        .network-info {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            text-align: center;
            font-size: 12px;
            color: #999;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé¨ Thanh to√°n Order</h1>
            <p>Thanh to√°n b·∫±ng CoinEx Smart Chain</p>
        </div>

        <div class="content">
            <!-- Th√¥ng tin Order -->
            <div class="order-info">
                <h2>Chi ti·∫øt ƒë∆°n h√†ng #<span id="orderId">-</span></h2>
                
                <div class="info-row">
                    <span class="info-label">üé• Phim:</span>
                    <span class="info-value" id="movieTitle">-</span>
                </div>
                
                <div class="info-row">
                    <span class="info-label">‚è∞ Su·∫•t chi·∫øu:</span>
                    <span class="info-value" id="showtime">-</span>
                </div>
                
                <div class="info-row">
                    <span class="info-label">üí∫ Gh·∫ø:</span>
                    <span class="info-value" id="seats">-</span>
                </div>

                <div class="price-section">
                    <div class="price-row">
                        <span>T·ªïng ti·ªÅn (VND):</span>
                        <span id="totalVND" style="font-weight: 600;">-</span>
                    </div>
                    <div class="price-row">
                        <span>T·ª∑ gi√°:</span>
                        <span style="font-weight: 600;">1 CET = 10,000 VND</span>
                    </div>
                    <div class="total-price">
                        <span id="totalCET">-</span> CET
                    </div>
                </div>
            </div>

            <!-- Tr·∫°ng th√°i v√≠ -->
            <div id="walletStatus" class="wallet-status">
                <p>‚úÖ ƒê√£ k·∫øt n·ªëi: <strong id="connectedAddress"></strong></p>
            </div>

            <!-- N√∫t k·∫øt n·ªëi/thanh to√°n -->
            <button id="connectBtn" class="btn btn-primary">
                üîó K·∫øt n·ªëi v√≠ MetaMask
            </button>

            <button id="payBtn" class="btn btn-success" style="display: none;">
                üí≥ Thanh to√°n ngay
            </button>

            <!-- Th√¥ng b√°o -->
            <div id="errorAlert" class="alert alert-error"></div>
            <div id="successAlert" class="alert alert-success"></div>

            <!-- Th√¥ng tin m·∫°ng -->
            <div class="network-info">
                <p>M·∫°ng: CoinEx Smart Chain Testnet</p>
                <p>ƒê·ªãa ch·ªâ nh·∫≠n: <strong id="merchantAddress">0x9cb7...77b63</strong></p>
            </div>
        </div>
    </div>

    <script>
        // C·∫•u h√¨nh
        const CONFIG = {
            chainId: '0x35',
            chainName: 'CoinEx Smart Chain Testnet',
            nativeCurrency: {
                name: 'CET',
                symbol: 'CET',
                decimals: 18
            },
            rpcUrls: ['https://testnet-rpc.coinex.net'],
            blockExplorerUrls: ['https://testnet.coinex.net'],
            merchantAddress: '0x9cb7a7c9a160cd7f16121953cfe0a1d598c77b63',
            // ‚ö†Ô∏è Thay ƒë·ªïi URL API th√†nh URL backend th·∫≠t c·ªßa b·∫°n
            apiBaseUrl: 'http://localhost:5136/api'
        };

        // State
        let userAccount = null;
        let isConnected = false;
        let orderData = null;

        // DOM Elements
        const connectBtn = document.getElementById('connectBtn');
        const payBtn = document.getElementById('payBtn');
        const walletStatus = document.getElementById('walletStatus');
        const connectedAddress = document.getElementById('connectedAddress');
        const errorAlert = document.getElementById('errorAlert');
        const successAlert = document.getElementById('successAlert');

        // L·∫•y orderId t·ª´ URL query string
        // V√≠ d·ª•: payment.html?orderId=123
        function getOrderIdFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get('orderId');
        }

        // Hi·ªÉn th·ªã l·ªói
        function showError(message) {
            errorAlert.innerHTML = `<p>‚ùå ${message}</p>`;
            errorAlert.style.display = 'block';
            successAlert.style.display = 'none';
            setTimeout(() => {
                errorAlert.style.display = 'none';
            }, 5000);
        }

        // Hi·ªÉn th·ªã th√†nh c√¥ng
        function showSuccess(message, txHash = null) {
            let html = `<p>‚úÖ ${message}</p>`;
            if (txHash) {
                html += `<p style="margin-top:10px; font-size:12px; word-break:break-all;">TX: ${txHash}</p>`;
                html += `<a href="${CONFIG.blockExplorerUrls[0]}/tx/${txHash}" target="_blank" style="color:#2196F3; font-size:12px;">Xem tr√™n Explorer ‚Üí</a>`;
            }
            successAlert.innerHTML = html;
            successAlert.style.display = 'block';
            errorAlert.style.display = 'none';
        }

        // L·∫•y th√¥ng tin Order t·ª´ backend
        async function loadOrderInfo() {
            try {
                const orderId = getOrderIdFromURL();
                if (!orderId) {
                    showError('Kh√¥ng t√¨m th·∫•y Order ID trong URL');
                    return;
                }

                // TODO: Th√™m JWT token v√†o header n·∫øu c·∫ßn authentication
                const response = await fetch(`${CONFIG.apiBaseUrl}/CryptoPayment/calculate/${orderId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}` // N·∫øu c√≥ JWT
                    }
                });

                if (!response.ok) {
                    throw new Error('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin Order');
                }

                const data = await response.json();
                orderData = data;

                // Hi·ªÉn th·ªã th√¥ng tin
                document.getElementById('orderId').textContent = data.orderId;
                document.getElementById('movieTitle').textContent = data.movieTitle || 'Avatar';
                document.getElementById('showtime').textContent = data.showtime || '19:00 - 11/11/2025';
                document.getElementById('seats').textContent = data.seats || 'A5, A6';
                document.getElementById('totalVND').textContent = data.totalPriceVND.toLocaleString('vi-VN') + ' VND';
                document.getElementById('totalCET').textContent = data.requiredCET.toFixed(4);

            } catch (error) {
                showError('L·ªói khi t·∫£i th√¥ng tin Order: ' + error.message);
                console.error(error);
            }
        }

        // K·∫øt n·ªëi v√≠
        async function connectWallet() {
            try {
                if (!window.ethereum) {
                    showError('Vui l√≤ng c√†i ƒë·∫∑t MetaMask!');
                    return;
                }

                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });

                userAccount = accounts[0];

                // Chuy·ªÉn m·∫°ng
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: CONFIG.chainId }],
                    });
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [CONFIG],
                        });
                    } else {
                        throw switchError;
                    }
                }

                // C·∫≠p nh·∫≠t UI
                isConnected = true;
                connectedAddress.textContent = `${userAccount.slice(0, 6)}...${userAccount.slice(-4)}`;
                walletStatus.style.display = 'block';
                walletStatus.classList.add('connected');
                connectBtn.style.display = 'none';
                payBtn.style.display = 'flex';

            } catch (error) {
                showError('L·ªói k·∫øt n·ªëi v√≠: ' + error.message);
            }
        }

        // Thanh to√°n
        async function processPayment() {
            try {
                if (!isConnected) {
                    showError('Vui l√≤ng k·∫øt n·ªëi v√≠ tr∆∞·ªõc!');
                    return;
                }

                if (!orderData) {
                    showError('Ch∆∞a c√≥ th√¥ng tin Order');
                    return;
                }

                payBtn.disabled = true;
                payBtn.innerHTML = '<div class="spinner"></div> ƒêang x·ª≠ l√Ω...';

                // T√≠nh s·ªë ti·ªÅn c·∫ßn tr·∫£ (CET)
                const amountInCET = orderData.requiredCET;
                const amountInWei = '0x' + (amountInCET * 1e18).toString(16);

                // G·ª≠i transaction
                const txHash = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        from: userAccount,
                        to: CONFIG.merchantAddress,
                        value: amountInWei
                    }],
                });

                showSuccess('ƒê√£ g·ª≠i giao d·ªãch! ƒêang x√°c nh·∫≠n...', txHash);

                // G·ªçi API backend ƒë·ªÉ x√°c nh·∫≠n
                await confirmPaymentWithBackend(txHash, amountInCET);

            } catch (error) {
                showError('L·ªói thanh to√°n: ' + error.message);
            } finally {
                payBtn.disabled = false;
                payBtn.innerHTML = 'üí≥ Thanh to√°n ngay';
            }
        }

        // X√°c nh·∫≠n thanh to√°n v·ªõi backend
        async function confirmPaymentWithBackend(txHash, amount) {
            try {
                const response = await fetch(`${CONFIG.apiBaseUrl}/cryptopayment/confirm`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}` // N·∫øu c√≥ JWT
                    },
                    body: JSON.stringify({
                        txHash: txHash,
                        userAddress: userAccount,
                        orderId: orderData.orderId,
                        amount: amount
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showSuccess('üéâ Thanh to√°n th√†nh c√¥ng! Order ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n.', txHash);
                    
                    // Redirect v·ªÅ trang order sau 3 gi√¢y
                    setTimeout(() => {
                        window.location.href = `/orders/${orderData.orderId}`;
                    }, 3000);
                } else {
                    showError(result.message || 'Kh√¥ng th·ªÉ x√°c nh·∫≠n thanh to√°n');
                }

            } catch (error) {
                showError('L·ªói k·∫øt n·ªëi backend: ' + error.message);
                console.error(error);
            }
        }

        // Event listeners
        connectBtn.addEventListener('click', connectWallet);
        payBtn.addEventListener('click', processPayment);

        // Load order info khi trang load
        window.addEventListener('load', async () => {
            await loadOrderInfo();

            // T·ª± ƒë·ªông k·∫øt n·ªëi n·∫øu ƒë√£ k·∫øt n·ªëi tr∆∞·ªõc ƒë√≥
            if (window.ethereum) {
                try {
                    const accounts = await window.ethereum.request({ 
                        method: 'eth_accounts' 
                    });
                    if (accounts.length > 0) {
                        userAccount = accounts[0];
                        isConnected = true;
                        connectedAddress.textContent = `${userAccount.slice(0, 6)}...${userAccount.slice(-4)}`;
                        walletStatus.style.display = 'block';
                        walletStatus.classList.add('connected');
                        connectBtn.style.display = 'none';
                        payBtn.style.display = 'flex';
                    }
                } catch (error) {
                    console.log('Not connected yet');
                }

                // Listen for account changes
                window.ethereum.on('accountsChanged', function (accounts) {
                    if (accounts.length === 0) {
                        isConnected = false;
                        userAccount = null;
                        walletStatus.style.display = 'none';
                        connectBtn.style.display = 'flex';
                        payBtn.style.display = 'none';
                    } else {
                        userAccount = accounts[0];
                        connectedAddress.textContent = `${userAccount.slice(0, 6)}...${userAccount.slice(-4)}`;
                    }
                });

                window.ethereum.on('chainChanged', () => window.location.reload());
            }
        });
    </script>
</body>
</html>